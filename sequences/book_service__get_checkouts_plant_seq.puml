@startuml View User Checkouts Sequence Diagram

title Просмотр сроков сдачи книг пользователем (Staff Only)

actor "Работник библиотеки" as Staff
participant "API Gateway" as Gateway
participant "BookingService" as Booking
participant "BookManagementService" as BMS

autonumber
== Запрос сроков сдачи пользователя ==
Staff -> Gateway: GET /api/v1/users/{userId}/checkouts?status=ACTIVE

Gateway -> Booking: Получить checkout займы пользователя
activate Booking

== Получение активных checkout займов ==
Booking -> Booking: Замаппить данные и найти checkout займы:\n- Поиск по userId = {userId}\n- Фильтрация по статусу (ACTIVE, OVERDUE)\n- Сортировка по дате возврата (asc)\n- Применение пагинации

alt Активных checkout займов нет
    Booking --> Gateway: 204 No Content
    Gateway --> Staff: 204 No Content - Нет активных займов
else Checkout займы найдены
    == Обогащение данными о книгах ==
    loop Для каждого checkout займа
        Booking -> BMS: Получить детальную информацию о книге
        activate BMS
        BMS -> BMS: Получить данные книги:\n- Основная информация\n- Авторы и издатель\n- Текущая доступность
        BMS --> Booking: BookDetails с актуальной информацией
        deactivate BMS
        
        Booking -> Booking: Обогатить checkout займ данными:\n- Добавить информацию о книге\n- Рассчитать дни до/после срока возврата\n- Определить уровень срочности\n- Вычислить сумму штрафа (если есть)
    end
    Booking -> Booking: Проанализировать и сгруппировать займы
    
    Booking --> Gateway: 200 OK - Checkout займы с информацией о сроках
    deactivate Booking
    
    Gateway --> Staff: 200 OK - Информация о сроках сдачи пользователя
end

@enduml